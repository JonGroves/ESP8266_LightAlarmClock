<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

	<head>
		<title>Light Alarm Clock</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<script src="jquery-1.6.4.min.js"></script>
<script>
	$(document).bind('mobileinit',function(){
		$.mobile.changePage.defaults.changeHash = false;
		$.mobile.hashListeningEnabled = false;
		$.mobile.pushStateEnabled = false;
	});
</script>
		<script src="jquery.mobile-1.1.2.min.js"></script>
		<link href="jquery.mobile.st-1.1.2.min.css" rel="stylesheet"/>
		<link href="jquery.mobile-1.1.2.min.css" rel="stylesheet" />
<script>

var ipValue;
var connection;
var oldRValue = 0;
var dataSenderTimer
var secondtimer

function onOpen(evt) {
	//alert("opened");
	document.getElementById("messages").innerHTML = "Connected";
	dataSenderTimer = setInterval(sendDataTimer ,100);	//Testing
	setTimeout(function(){}, 500);	//wait 100 ms
	//secondtimer = setInterval(secondTimer ,10000);	//Testing
	connection.send("getNTP");	//Testing
}

function onClose(evt) {
	clearInterval(dataSenderTimer);	//Testing
	clearInterval(secondtimer);//Testing
}

function onError(evt) {
	 //alert(evt.data);
}
function onMessage(evt) {
	if(evt.data.startsWith("Time Message:"))
	{
		document.getElementById("timeMessage").innerHTML = evt.data;
	}
	else
	{
		document.getElementById("messages").innerHTML = evt.data;
	}
}

function sendDataTimer() {	//Testing
	var sliderValue = document.getElementById("slider1-range").value;	//Testing
	if (oldRValue != sliderValue)	//Testing
	{	//Testing
		oldRValue = sliderValue;	//Testing
		connection.send("x"+sliderValue);	//Testing
	}	//Testing
}	//Testing
/*
function secondTimer() {	//Testing
	connection.send("getNTP");	//Testing
}	//Testing
*/
function ledFn() {
	var toSend = "LED";
	connection.send(toSend);
};

function resetFn() {
	var toSend = "RESET";
	connection.send(toSend);
};

function createWebsocket(){
document.getElementById("messages").innerHTML = "Connecting...";
var text = document.getElementById('ip').value;
ipValue = text;
connection = new WebSocket(ipValue, ['arduino']);
connection.onopen = function(evt) { onOpen(evt) };
connection.onclose = function(evt) { onClose(evt) };
connection.onmessage = function(evt) { onMessage(evt) };
connection.onerror = function(evt) { onError(evt) };
console.log(text)
console.log("IP value changed to:"+ipValue);
}
/*
function showValueR(newValue)
				{
					  if (!(sentRecently))
						{
							sentRecently = true;
							connection.send("x"+newValue);
							 setTimeout(function(){}, 100);	//wait 100 ms
							 sentRecently = false;
						 }
				}*/
/*
function showValueG(newValue)
				{
						connection.send("y"+newValue);
				}
function showValueB(newValue)
			{
					connection.send("z"+newValue);
			}
function setRainbowSpeed(newValue)
			{
					connection.send("t"+newValue);
			}

function hexToRgb(hex) {
	var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
	return result ? {
		r: parseInt(result[1], 16),
		g: parseInt(result[2], 16),
		b: parseInt(result[3], 16)
	} : null;
}

function sendColor(newValue)
{
		var RGBColor = hexToRgb(newValue);
		console.log(RGBColor);
		showValueR(Math.round(RGBColor.r/255*1023));
		showValueG(Math.round(RGBColor.g/255*1023));
		showValueB(Math.round(RGBColor.b/255*1023));
}

function rainbowFn() {
	var toSend = "RAINBOW";
	connection.send(toSend);
};
*/

</script>
	  </head>
	<body>

		<div data-role="page" id="page1">
			<div data-role="header">
				<h1>Light Alarm Clock</h1>
			</div>
			<div data-role="content">
			  <div data-role="fieldcontain">
				  <label for="time1">Wakeup Time</label>
				  <form>
				  <input type=time name=JTime onchange="this.form.submit()" >
				  </form>
			  </div>

				<div data-role="fieldcontain">
					<label for="text1">WebSocket IP</label>
					<input type="text" id="ip" value="ws://192.168.2.123:81/" onblur='createWebsocket()' />
				</div>
				<div data-role="fieldcontain">
					<label for="text2">Reconnect</label>
					<input type="button" onclick='createWebsocket()' />
				</div>
				<div data-role="fieldcontain" id="slider1">
					<label for="slider1-range">Manual Control</label>
					<input type="range" id="slider1-range" value="0" min="0" max="175" step="1" data-highlight="true" />
				</div>
 				<!--
 				<div data-role="fieldcontain" id="slider2">
					<label for="slider2-range">Green</label>
					<input type="range" id="slider2-range" value="0" min="0" max="1023" onchange="showValueG(this.value)"
					step="5" data-highlight="true" />
				</div>
				<div data-role="fieldcontain" id="slider3">
					<label for="slider3-range">Blue</label>
					<input type="range" id="slider3-range" value="0" min="0" max="1023" onchange="showValueB(this.value)"
					step="5" data-highlight="true" />
				</div>
				 <div data-role="fieldcontain" id="slider3">
				 <label for="slider3-range">Pick Any Color</label>
					<input type="color" id="html5colorpicker" onchange="sendColor(this.value)" value="#ff0000" style="width:85%;">
				</div>
				<div class="ui-grid-b">
					<div class="ui-block-a">
						<a data-role="button" id="Blink" onclick="ledFn()" data-inline="true">Blink</a>
					</div>
					<div class="ui-block-b">
						<a data-role="button" id="Reset" onclick="resetFn()" data-inline="true">Reset</a>
					</div>
					<div class="ui-block-c">
						<a data-role="button" id="Rainbow" onclick="rainbowFn()" data-inline="true">Rainbow</a>
					</div>
				</div>
			   <div data-role="fieldcontain" id="slider3">
					<label for="slider3-range">Rainbow Speed</label>
					<input type="range" id="slider3-range" value="0" min="10" max="2000" onchange="setRainbowSpeed(this.value)"
					step="5" data-highlight="true" />
				</div>
				-->
			</div>
			<p id="messages">	-	</p>
			<p id="timeMessage">	-	</p>
			<div data-role="footer">
				<h1>Version 2016.07.12</h1>
			</div>
		</div>
	</body>
	<script>createWebsocket()</script>
</html>
